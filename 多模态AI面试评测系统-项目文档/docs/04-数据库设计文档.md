# 数据库设计文档

## 多模态智能面试评测系统

**文档版本**：v1.0  
**创建日期**：2025年12月  
**数据库**：PostgreSQL 15+

---

## 一、设计概述

### 1.1 设计原则

- 遵循第三范式，适度反范式优化查询性能
- 使用UUID作为主键，便于分布式扩展
- 软删除设计，保留数据审计能力
- 敏感数据加密存储

### 1.2 命名规范

- 表名：小写下划线，复数形式（如 `users`、`interviews`）
- 字段名：小写下划线（如 `created_at`、`user_id`）
- 索引名：`idx_表名_字段名`
- 外键名：`fk_表名_关联表名`

---

## 二、ER图

```text
┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│    users     │       │  enterprises │       │  positions   │
├──────────────┤       ├──────────────┤       ├──────────────┤
│ id (PK)      │       │ id (PK)      │       │ id (PK)      │
│ email        │       │ name         │       │ enterprise_id│──┐
│ username     │       │ industry     │       │ title        │  │
│ password_hash│       │ ...          │       │ category     │  │
│ role         │◄──────│              │       │ ...          │  │
│ enterprise_id│       └──────────────┘       └──────────────┘  │
└──────┬───────┘                                     │          │
       │                                             │          │
       │       ┌─────────────────────────────────────┘          │
       │       │                                                │
       │       ▼                                                │
       │  ┌──────────────┐       ┌──────────────┐              │
       │  │  questions   │       │  interviews  │              │
       │  ├──────────────┤       ├──────────────┤              │
       │  │ id (PK)      │       │ id (PK)      │              │
       │  │ position_id  │◄──────│ position_id  │◄─────────────┘
       │  │ content      │       │ candidate_id │◄───┐
       │  │ type         │       │ status       │    │
       │  │ ...          │       │ ...          │    │
       │  └──────────────┘       └──────┬───────┘    │
       │                                │            │
       └────────────────────────────────┼────────────┘
                                        │
                                        ▼
                               ┌──────────────┐
                               │   answers    │
                               ├──────────────┤
                               │ id (PK)      │
                               │ interview_id │
                               │ question_id  │
                               │ audio_url    │
                               │ video_url    │
                               │ transcript   │
                               │ ...          │
                               └──────┬───────┘
                                      │
           ┌──────────────────────────┼──────────────────────────┐
           │                          │                          │
           ▼                          ▼                          ▼
    ┌──────────────┐          ┌──────────────┐          ┌──────────────┐
    │speech_analysis│         │video_analysis │         │ text_analysis │
    ├──────────────┤          ├──────────────┤          ├──────────────┤
    │ id (PK)      │          │ id (PK)      │          │ id (PK)      │
    │ answer_id    │          │ answer_id    │          │ answer_id    │
    │ emotion      │          │ expression   │          │ content_score│
    │ speech_rate  │          │ eye_contact  │          │ logic_score  │
    │ ...          │          │ ...          │          │ ...          │
    └──────────────┘          └──────────────┘          └──────────────┘
                                      │
                                      ▼
                              ┌──────────────┐
                              │   reports    │
                              ├──────────────┤
                              │ id (PK)      │
                              │ interview_id │
                              │ overall_score│
                              │ ability_scores│
                              │ ...          │
                              └──────────────┘
```

---

## 三、表结构设计

### 3.1 用户表 (users)

存储系统用户基本信息。

```sql
CREATE TABLE users (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email           VARCHAR(255) NOT NULL UNIQUE,
    username        VARCHAR(100) NOT NULL,
    password_hash   VARCHAR(255) NOT NULL,
    phone           VARCHAR(20),
    avatar          VARCHAR(500),
    role            VARCHAR(20) NOT NULL DEFAULT 'candidate',  -- candidate/enterprise/admin
    enterprise_id   UUID REFERENCES enterprises(id),
    status          VARCHAR(20) NOT NULL DEFAULT 'active',     -- active/inactive/banned
    last_login_at   TIMESTAMP WITH TIME ZONE,
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at      TIMESTAMP WITH TIME ZONE,
    
    CONSTRAINT chk_role CHECK (role IN ('candidate', 'enterprise', 'admin')),
    CONSTRAINT chk_status CHECK (status IN ('active', 'inactive', 'banned'))
);

-- 索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_enterprise_id ON users(enterprise_id);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_created_at ON users(created_at);
```

字段说明：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| email | VARCHAR(255) | 邮箱，唯一 |
| username | VARCHAR(100) | 用户名 |
| password_hash | VARCHAR(255) | 密码哈希值 |
| phone | VARCHAR(20) | 手机号 |
| avatar | VARCHAR(500) | 头像URL |
| role | VARCHAR(20) | 角色：candidate/enterprise/admin |
| enterprise_id | UUID | 所属企业ID |
| status | VARCHAR(20) | 状态 |
| last_login_at | TIMESTAMP | 最后登录时间 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | 删除时间（软删除） |

### 3.2 企业表 (enterprises)

存储企业信息。

```sql
CREATE TABLE enterprises (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name            VARCHAR(200) NOT NULL,
    industry        VARCHAR(100),
    scale           VARCHAR(50),          -- 企业规模
    description     TEXT,
    logo            VARCHAR(500),
    website         VARCHAR(500),
    contact_name    VARCHAR(100),
    contact_phone   VARCHAR(20),
    contact_email   VARCHAR(255),
    status          VARCHAR(20) NOT NULL DEFAULT 'active',
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at      TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_enterprises_name ON enterprises(name);
CREATE INDEX idx_enterprises_industry ON enterprises(industry);
```

### 3.3 岗位表 (positions)

存储招聘岗位信息。

```sql
CREATE TABLE positions (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    enterprise_id       UUID NOT NULL REFERENCES enterprises(id),
    title               VARCHAR(200) NOT NULL,
    category            VARCHAR(50) NOT NULL,    -- ai/bigdata/iot/system
    description         TEXT,
    requirements        JSONB,                   -- 岗位要求数组
    interview_duration  INTEGER DEFAULT 30,      -- 面试时长（分钟）
    question_count      INTEGER DEFAULT 5,       -- 题目数量
    interviewer_styles  VARCHAR(50)[] DEFAULT ARRAY['friendly'],  -- 支持的面试官风格
    ability_weights     JSONB,                   -- 能力维度权重配置
    status              VARCHAR(20) NOT NULL DEFAULT 'active',
    view_count          INTEGER DEFAULT 0,
    interview_count     INTEGER DEFAULT 0,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at          TIMESTAMP WITH TIME ZONE,
    
    CONSTRAINT chk_category CHECK (category IN ('ai', 'bigdata', 'iot', 'system', 'other'))
);

CREATE INDEX idx_positions_enterprise_id ON positions(enterprise_id);
CREATE INDEX idx_positions_category ON positions(category);
CREATE INDEX idx_positions_status ON positions(status);
```

ability_weights JSONB 示例：

```json
{
    "professional_knowledge": 0.25,
    "logical_thinking": 0.20,
    "language_expression": 0.20,
    "stress_resistance": 0.20,
    "communication_potential": 0.15
}
```

### 3.4 题库表 (questions)

存储面试题目。

```sql
CREATE TABLE questions (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    position_id         UUID REFERENCES positions(id),
    content             TEXT NOT NULL,
    type                VARCHAR(50) NOT NULL,    -- basic/technical/behavioral
    difficulty          VARCHAR(20) NOT NULL,    -- easy/medium/hard
    time_limit          INTEGER DEFAULT 180,     -- 回答时限（秒）
    follow_up_enabled   BOOLEAN DEFAULT true,
    reference_answer    TEXT,
    scoring_points      JSONB,                   -- 评分要点
    usage_count         INTEGER DEFAULT 0,
    avg_score           DECIMAL(5,2),
    status              VARCHAR(20) NOT NULL DEFAULT 'active',
    created_by          UUID REFERENCES users(id),
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    deleted_at          TIMESTAMP WITH TIME ZONE,
    
    CONSTRAINT chk_type CHECK (type IN ('basic', 'technical', 'behavioral', 'situational')),
    CONSTRAINT chk_difficulty CHECK (difficulty IN ('easy', 'medium', 'hard'))
);

CREATE INDEX idx_questions_position_id ON questions(position_id);
CREATE INDEX idx_questions_type ON questions(type);
CREATE INDEX idx_questions_difficulty ON questions(difficulty);
```

### 3.5 面试表 (interviews)

存储面试会话信息。

```sql
CREATE TABLE interviews (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    candidate_id        UUID NOT NULL REFERENCES users(id),
    position_id         UUID NOT NULL REFERENCES positions(id),
    enterprise_id       UUID NOT NULL REFERENCES enterprises(id),
    interviewer_style   VARCHAR(50) DEFAULT 'friendly',
    status              VARCHAR(30) NOT NULL DEFAULT 'created',
    -- created/device_checking/in_progress/completed/cancelled/expired
    question_ids        UUID[],                  -- 本次面试的题目ID列表
    current_question_index INTEGER DEFAULT 0,
    total_duration      INTEGER,                 -- 总时长（秒）
    room_token          VARCHAR(500),            -- 音视频房间Token
    device_info         JSONB,                   -- 设备信息
    scheduled_at        TIMESTAMP WITH TIME ZONE,
    started_at          TIMESTAMP WITH TIME ZONE,
    ended_at            TIMESTAMP WITH TIME ZONE,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_status CHECK (status IN ('created', 'device_checking', 'in_progress', 'completed', 'cancelled', 'expired'))
);

CREATE INDEX idx_interviews_candidate_id ON interviews(candidate_id);
CREATE INDEX idx_interviews_position_id ON interviews(position_id);
CREATE INDEX idx_interviews_enterprise_id ON interviews(enterprise_id);
CREATE INDEX idx_interviews_status ON interviews(status);
CREATE INDEX idx_interviews_created_at ON interviews(created_at);
```

### 3.6 回答表 (answers)

存储候选人的面试回答。

```sql
CREATE TABLE answers (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    interview_id        UUID NOT NULL REFERENCES interviews(id),
    question_id         UUID NOT NULL REFERENCES questions(id),
    order_index         INTEGER NOT NULL,        -- 题目顺序
    is_follow_up        BOOLEAN DEFAULT false,
    parent_answer_id    UUID REFERENCES answers(id),  -- 追问的父回答
    audio_url           VARCHAR(500),
    video_url           VARCHAR(500),
    transcript          TEXT,                    -- 语音转文本
    duration            INTEGER,                 -- 回答时长（秒）
    status              VARCHAR(20) DEFAULT 'submitted',
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_answers_interview_id ON answers(interview_id);
CREATE INDEX idx_answers_question_id ON answers(question_id);
CREATE INDEX idx_answers_parent_answer_id ON answers(parent_answer_id);
```

### 3.7 语音分析表 (speech_analysis)

存储语音分析结果。

```sql
CREATE TABLE speech_analysis (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    answer_id           UUID NOT NULL REFERENCES answers(id) UNIQUE,
    
    -- ASR结果
    transcript          TEXT,
    word_count          INTEGER,
    
    -- 语速分析
    speech_rate         DECIMAL(5,2),            -- 每分钟字数
    speech_rate_level   VARCHAR(20),             -- slow/moderate/fast
    
    -- 流畅度分析
    fluency_score       DECIMAL(5,2),            -- 0-100
    pause_count         INTEGER,                 -- 停顿次数
    pause_total_duration INTEGER,                -- 停顿总时长（毫秒）
    filler_word_count   INTEGER,                 -- 语气词次数
    
    -- 情感分析
    emotion             VARCHAR(50),             -- 主要情感
    emotion_confidence  DECIMAL(5,4),
    emotion_timeline    JSONB,                   -- 情感时间线
    
    -- 音量分析
    volume_mean         DECIMAL(8,4),
    volume_std          DECIMAL(8,4),
    volume_stability    DECIMAL(5,2),
    
    -- 综合得分
    overall_score       DECIMAL(5,2),
    
    raw_data            JSONB,                   -- 原始分析数据
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_speech_analysis_answer_id ON speech_analysis(answer_id);
```

### 3.8 视频分析表 (video_analysis)

存储视频分析结果。

```sql
CREATE TABLE video_analysis (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    answer_id           UUID NOT NULL REFERENCES answers(id) UNIQUE,
    
    -- 表情分析
    dominant_expression VARCHAR(50),             -- 主要表情
    expression_distribution JSONB,               -- 表情分布
    expression_timeline JSONB,                   -- 表情时间线
    
    -- 眼神分析
    eye_contact_ratio   DECIMAL(5,4),            -- 眼神接触比例
    eye_contact_score   DECIMAL(5,2),
    gaze_stability      DECIMAL(5,2),            -- 注视稳定性
    
    -- 肢体语言
    posture_score       DECIMAL(5,2),            -- 姿态得分
    gesture_frequency   DECIMAL(5,2),            -- 手势频率
    head_movement_score DECIMAL(5,2),            -- 头部动作得分
    
    -- 自信度分析
    confidence_score    DECIMAL(5,2),
    confidence_timeline JSONB,
    
    -- 综合得分
    overall_score       DECIMAL(5,2),
    
    raw_data            JSONB,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_video_analysis_answer_id ON video_analysis(answer_id);
```

### 3.9 文本分析表 (text_analysis)

存储文本内容分析结果。

```sql
CREATE TABLE text_analysis (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    answer_id           UUID NOT NULL REFERENCES answers(id) UNIQUE,
    
    -- 内容质量
    content_relevance   DECIMAL(5,2),            -- 内容相关度
    content_depth       DECIMAL(5,2),            -- 内容深度
    content_completeness DECIMAL(5,2),           -- 内容完整度
    
    -- 逻辑分析
    logic_score         DECIMAL(5,2),            -- 逻辑性得分
    structure_type      VARCHAR(50),             -- 结构类型（STAR等）
    argument_count      INTEGER,                 -- 论点数量
    
    -- 专业性分析
    professional_terms  JSONB,                   -- 专业术语列表
    professional_score  DECIMAL(5,2),
    
    -- 关键信息
    key_points          JSONB,                   -- 关键要点提取
    highlights          JSONB,                   -- 亮点
    weaknesses          JSONB,                   -- 不足
    
    -- 大模型评估
    llm_evaluation      TEXT,                    -- 大模型评语
    llm_score           DECIMAL(5,2),
    
    -- 综合得分
    overall_score       DECIMAL(5,2),
    
    raw_data            JSONB,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_text_analysis_answer_id ON text_analysis(answer_id);
```

### 3.10 评测报告表 (reports)

存储最终评测报告。

```sql
CREATE TABLE reports (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    interview_id        UUID NOT NULL REFERENCES interviews(id) UNIQUE,
    
    -- 综合评分
    overall_score       DECIMAL(5,2) NOT NULL,
    recommendation      VARCHAR(30),             -- recommend/pending/not_recommend
    
    -- 能力维度得分
    ability_scores      JSONB NOT NULL,
    /*
    {
        "professional_knowledge": 88,
        "logical_thinking": 82,
        "language_expression": 86,
        "stress_resistance": 80,
        "communication_potential": 85
    }
    */
    
    -- 各模态维度得分
    speech_score        DECIMAL(5,2),
    video_score         DECIMAL(5,2),
    content_score       DECIMAL(5,2),
    
    -- 详细分析
    dimension_details   JSONB,                   -- 各维度详细数据
    
    -- 亮点与改进建议
    highlights          JSONB,                   -- 亮点时刻
    improvements        JSONB,                   -- 改进建议
    
    -- 排名信息
    rank_in_position    INTEGER,                 -- 在该岗位的排名
    percentile          DECIMAL(5,2),            -- 百分位
    
    -- 报告状态
    status              VARCHAR(20) DEFAULT 'generated',
    reviewed_by         UUID REFERENCES users(id),
    reviewed_at         TIMESTAMP WITH TIME ZONE,
    
    generated_at        TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_reports_interview_id ON reports(interview_id);
CREATE INDEX idx_reports_overall_score ON reports(overall_score);
CREATE INDEX idx_reports_recommendation ON reports(recommendation);
```

### 3.11 追问记录表 (follow_up_questions)

存储AI生成的追问问题。

```sql
CREATE TABLE follow_up_questions (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    interview_id        UUID NOT NULL REFERENCES interviews(id),
    answer_id           UUID NOT NULL REFERENCES answers(id),
    content             TEXT NOT NULL,
    generation_reason   TEXT,                    -- 生成原因
    prompt_used         TEXT,                    -- 使用的Prompt
    was_asked           BOOLEAN DEFAULT false,   -- 是否已提问
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_follow_up_questions_interview_id ON follow_up_questions(interview_id);
CREATE INDEX idx_follow_up_questions_answer_id ON follow_up_questions(answer_id);
```

### 3.12 系统日志表 (system_logs)

存储系统操作日志。

```sql
CREATE TABLE system_logs (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id             UUID REFERENCES users(id),
    action              VARCHAR(100) NOT NULL,
    resource_type       VARCHAR(50),
    resource_id         UUID,
    details             JSONB,
    ip_address          INET,
    user_agent          TEXT,
    created_at          TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_system_logs_user_id ON system_logs(user_id);
CREATE INDEX idx_system_logs_action ON system_logs(action);
CREATE INDEX idx_system_logs_created_at ON system_logs(created_at);

-- 按时间分区（可选）
-- CREATE TABLE system_logs_2025_01 PARTITION OF system_logs
-- FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

---

## 四、索引策略

### 4.1 主要索引

| 表 | 索引 | 类型 | 用途 |
|----|----|------|------|
| users | idx_users_email | B-tree | 登录查询 |
| interviews | idx_interviews_candidate_id | B-tree | 用户面试列表 |
| interviews | idx_interviews_status | B-tree | 状态筛选 |
| reports | idx_reports_overall_score | B-tree | 分数排序 |
| answers | idx_answers_interview_id | B-tree | 面试答案查询 |

### 4.2 复合索引

```sql
-- 企业端查询面试列表
CREATE INDEX idx_interviews_enterprise_status_created 
ON interviews(enterprise_id, status, created_at DESC);

-- 岗位筛选
CREATE INDEX idx_positions_enterprise_category_status 
ON positions(enterprise_id, category, status);
```

---

## 五、数据迁移脚本

### 5.1 初始化脚本

```sql
-- 创建扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- 创建枚举类型
CREATE TYPE user_role AS ENUM ('candidate', 'enterprise', 'admin');
CREATE TYPE interview_status AS ENUM ('created', 'device_checking', 'in_progress', 'completed', 'cancelled', 'expired');
CREATE TYPE question_type AS ENUM ('basic', 'technical', 'behavioral', 'situational');
CREATE TYPE difficulty_level AS ENUM ('easy', 'medium', 'hard');

-- 创建更新时间触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 为各表添加触发器
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- 其他表类似...
```

---

## 六、数据备份策略

### 6.1 备份计划

| 备份类型 | 频率 | 保留期限 |
|----------|------|----------|
| 全量备份 | 每日 | 30天 |
| 增量备份 | 每小时 | 7天 |
| 事务日志 | 实时 | 24小时 |

### 6.2 备份脚本示例

```bash
#!/bin/bash
# 每日全量备份
DATE=$(date +%Y%m%d)
pg_dump -h localhost -U postgres interview_db > /backup/full_${DATE}.sql
# 压缩
gzip /backup/full_${DATE}.sql
# 上传到云存储
aws s3 cp /backup/full_${DATE}.sql.gz s3://backup-bucket/
```

---

## 七、性能优化建议

### 7.1 查询优化

- 对高频查询添加适当索引
- 使用EXPLAIN ANALYZE分析慢查询
- 避免SELECT *，只查询需要的字段
- 合理使用分页，避免大偏移量

### 7.2 存储优化

- 大文本字段考虑使用TOAST
- 历史数据归档到冷存储
- 日志表按时间分区

### 7.3 连接池配置

```python
# SQLAlchemy配置示例
SQLALCHEMY_ENGINE_OPTIONS = {
    "pool_size": 20,
    "max_overflow": 40,
    "pool_pre_ping": True,
    "pool_recycle": 3600,
}
```

---

文档修订记录

| 版本 | 日期 | 修订人 | 修订内容 |
|------|------|--------|----------|
| v1.0 | 2025-12 | - | 初稿创建 |
